{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "url": "data/anime-genres.csv"
  },
  "vconcat": [
    {
      "hconcat": [
        {
          "title": {
              "text": "Top 30 Anime and Their Genres",
              "fontSize": 24,
              "fontWeight": "bold",
              "anchor": "start",
              "color": "black",
              "font": "Gravitas One"
          },
          "width": 600,
          "height": {"step": 15},
          "transform": [
            {
              "window": [{"op": "dense_rank", "as": "rank"}],
              "sort": [{"field": "score", "order": "descending"}]
            },
            {
              "filter": "datum.rank <= 30"
            },
            {
              "calculate": "datum.genre === '' ? 'Others' : datum.genre",
              "as": "AdjustedGenre"
            },
            {
              "lookup": "title",
              "from": {
                "data": {"url": "data/anime-genres.csv"},
                "key": "title",
                "fields": ["score"]
              },
              "as": "top10Flag"
            },
            {
              "calculate": "datum.top10Flag >= 9 ? true : false",
              "as": "isTop10"
            }
          ],
          "mark": {
            "type": "rect",
            "tooltip": true,
            "stroke": "white",
            "strokeWidth": 1
          },
          "encoding": {
            "x": {
              "field": "title",
              "type": "nominal",
              "title": "Anime Title",
              "sort": {"field": "score", "order": "descending"},
              "axis": {
                "labelAngle": -45,
                "labelAlign": "right",
                "labelLimit": 150
              }
            },
            "y": {
              "field": "AdjustedGenre",
              "type": "nominal",
              "title": "Genre"
            },
            "color": {
              "condition": {
                "test": "datum.isTop10",
                "value": "#6a0dad"
              },
              "value": "#D5B1FF"
            },
            "tooltip": [
              {"field": "title", "type": "nominal", "title": "Anime"},
              {"field": "AdjustedGenre", "type": "nominal", "title": "Genre"},
              {"field": "score", "type": "quantitative", "title": "Score", "format": ".2f"}
            ]
          }
        },
        {
          "title": {
              "text": "Top 10 Anime Genres",
              "fontSize": 24,
              "fontWeight": "bold",
              "anchor": "start",
              "color": "black",
              "font": "Gravitas One"
          },
          "width": 710,
          "height": 500,
          "transform": [
            {
              "calculate": "datum.genre === '' ? 'Others' : datum.genre",
              "as": "AdjustedGenre"
            },
            {
              "aggregate": [{"op": "count", "as": "GenreCount"}],
              "groupby": ["AdjustedGenre"]
            },
            {
              "joinaggregate": [{"op": "sum", "field": "GenreCount", "as": "TotalAnimes"}]
            },
            {
              "calculate": "datum.GenreCount / datum.TotalAnimes * 100",
              "as": "Percentage"
            },
            {
              "window": [{"op": "rank", "as": "rank"}],
              "sort": [{"field": "GenreCount", "order": "descending"}]
            },
            {
              "filter": "datum.rank <= 10"
            }
          ],
          "layer": [
            {
              "mark": {"type": "rule", "strokeWidth": 5},
              "encoding": {
                "y": {
                  "field": "AdjustedGenre",
                  "type": "nominal",
                  "title": "Anime Genre",
                  "sort": {"field": "Percentage", "order": "descending"}
                },
                "x": {"field": "Percentage", "type": "quantitative", "title": "Percentage of Total Animes (%)"},
                "x2": {"datum": 0},
                "color": {
                  "condition": {"test": "datum.AdjustedGenre === 'Comedy'", "value": "#ff7f0e"},
                  "value": "#D5B1FF"
                },
                "tooltip": [
                  {"field": "AdjustedGenre", "type": "nominal", "title": "Genre"},
                  {"field": "GenreCount", "type": "quantitative", "title": "Number of Animes"},
                  {"field": "Percentage", "type": "quantitative", "format": ".2f", "title": "Percentage of Animes (%)"}
                ]
              }
            },
            {
              "mark": {"type": "point", "filled": true, "size": 300},
              "encoding": {
                "y": {"field": "AdjustedGenre", "type": "nominal", "sort": {"field": "Percentage", "order": "descending"}},
                "x": {"field": "Percentage", "type": "quantitative"},
                "color": {"condition": {"test": "datum.AdjustedGenre === 'Comedy'", "value": "#ff7f0e"}, "value": "#D5B1FF"},
                "tooltip": [
                  {"field": "AdjustedGenre", "type": "nominal", "title": "Genre"},
                  {"field": "GenreCount", "type": "quantitative", "title": "Number of Animes"},
                  {"field": "Percentage", "type": "quantitative", "format": ".2f", "title": "Percentage of Animes (%)"}
                ]
              }
            },
            {
              "mark": {"type": "text", "align": "center", "baseline": "middle", "fontSize": 12, "fontStyle": "italic", "dy": -60, "dx": -200},
              "encoding": {
                "x": {"aggregate": "max", "field": "Percentage", "type": "quantitative"},
                "text": {"value": "The Comedy genre dominates with the highest percentage of all existing anime,"},
                "color": {"value": "black"}
              },
              "transform": [{"filter": {"field": "AdjustedGenre", "oneOf": ["Comedy"]}}]
            },
            {
              "mark": {"type": "text", "align": "center", "baseline": "middle", "fontSize": 12, "fontStyle": "italic", "dy": -40, "dx": -200},
              "encoding": {
                "x": {"aggregate": "max", "field": "Percentage", "type": "quantitative"},
                "text": {"value": "showcasing its widespread popularity across the medium."},
                "color": {"value": "black"}
              },
              "transform": [{"filter": {"field": "AdjustedGenre", "oneOf": ["Comedy"]}}]
            }
          ]
        }
      ]
    },
    {
      "title": {
          "text": "Top 10 Highest Rated Anime",
          "fontSize": 24,
          "fontWeight": "bold",
          "anchor": "start",
          "color": "black",
          "font": "Gravitas One"
      },
      "width": 1400,
      "height": 200,
      "data": {"url": "data/anime-genres.csv"},
      "transform": [
        {
          "aggregate": [{"op": "max", "field": "score", "as": "max_score"}],
          "groupby": ["uid", "title"]
        },
        {
          "window": [{"op": "dense_rank", "as": "rank"}],
          "sort": [{"field": "max_score", "order": "descending"}]
        },
        {
          "filter": "datum.rank <= 10"
        }
      ],
      "layer": [
        {
          "mark": {"type": "bar", "color": "#D5B1FF"},
          "encoding": {
            "x": {"field": "max_score", "type": "quantitative", "title": "Rating Score", "scale": {"domain": [8.9, 9.25]}},
            "x2": {"datum": 8.9},
            "y": {"field": "title", "type": "nominal", "title": "Anime Title", "sort": {"field": "max_score", "order": "descending"}},
            "tooltip": [
              {"field": "title", "type": "nominal", "title": "Anime Title"},
              {"field": "max_score", "type": "quantitative", "title": "Score", "format": ".2f"}
            ]
          }
        },
        {
          "data": {"url": "data/anime-genres.csv"},
          "transform": [
            {
              "aggregate": [{"op": "max", "field": "score", "as": "max_score"}],
              "groupby": ["uid", "title"]
            },
            {
              "window": [{"op": "dense_rank", "as": "rank"}],
              "sort": [{"field": "max_score", "order": "descending"}]
            },
            {
              "filter": "datum.rank <= 10"
            },
            {
              "lookup": "uid",
              "from": {"data": {"url": "data/anime-genres.csv"}, "key": "uid", "fields": ["genre"]}
            }
          ],
          "mark": {"type": "point", "opacity": 0, "size": 1000},
          "encoding": {
            "x": {"field": "max_score", "type": "quantitative"},
            "y": {"field": "title", "type": "nominal", "sort": {"field": "max_score", "order": "descending"}},
            "tooltip": [
              {"field": "title", "type": "nominal", "title": "Anime Title"},
              {"field": "max_score", "type": "quantitative", "title": "Score", "format": ".2f"},
              {"field": "genre", "type": "nominal", "title": "Genre"}
            ]
          }
        }
      ]
    }
  ],
  "config": {
        "axis": {
            "labelFont": "Comic Sans MS",
            "titleFont": "Comic Sans MS"
        },
        "legend": {
            "labelFont": "Comic Sans MS",
            "titleFont": "Comic Sans MS"
        },
        "text": {
            "font": "Comic Sans MS"
        },
        "header": {
            "labelFont": "Comic Sans MS",
            "titleFont": "Comic Sans MS"
        }
    }
}
